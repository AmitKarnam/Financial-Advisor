<!DOCTYPE html>
<html>
<head>
  <title>Financial Advisor Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .chat-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
      height: 70vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message {
      margin: 10px 0;
      padding: 15px;
      border-radius: 10px;
      max-width: 85%;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.5;
    }
    .user-message {
      background-color: #007bff;
      color: white;
      margin-left: auto;
      align-self: flex-end;
    }
    .agent-message {
      background-color: #f8f9fa;
      color: black;
      border: 1px solid #e9ecef;
      align-self: flex-start;
    }
    .message p {
      margin: 0 0 10px 0;
    }
    .message:last-child p {
      margin-bottom: 0;
    }
    .message ul {
      margin: 10px 0;
    }
    .message li {
      margin: 8px 0;
      line-height: 1.5;
    }
    .input-container {
      display: flex;
      gap: 10px;
    }
    input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:disabled {
      background-color: #ccc;
    }
    .typing {
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Financial Advisor Chat</h1>
  <div class="chat-container" id="chat"></div>
  <div class="input-container">
    <input type="text" id="msg" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
    <button onclick="send()" id="sendBtn">Send</button>
  </div>

  <script>
    const chatDiv = document.getElementById('chat');
    const msgInput = document.getElementById('msg');
    const sendBtn = document.getElementById('sendBtn');
    let evtSource = null;

    function formatText(text) {
      // Replace markdown bullet points with HTML list items
      let formatted = text.replace(/^\s*\*\s+(.+)$/gm, '<li>$1</li>');
      // Replace numbered lists (1. ...) with HTML list items
      formatted = formatted.replace(/^\s*\d+\.\s+(.+)$/gm, '<li>$1</li>');
      // Replace markdown bold (**text**) with <strong>text</strong>
      formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

      // Split into paragraphs on double newlines
      const paragraphs = formatted.split(/\n\n+/);

      return paragraphs.map(para => {
        // If paragraph contains list items, wrap in ul
        if (para.includes('<li>')) {
          return `<ul style="margin: 0; padding-left: 20px;">${para}</ul>`;
        }
        // Otherwise, split on single newlines for line breaks
        return para.trim() ? `<p>${para.trim().replace(/\n/g, '<br>')}</p>` : '';
      }).join('');
    }

    function appendMessage(text, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user-message' : 'agent-message'}`;
      
      // Rebuild message rendering for paragraphs, lists, and markdown
      function renderMessage(raw) {
        // Convert markdown bold to <strong>
        raw = raw.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        // Split into blocks by double newlines (paragraphs or lists)
        const blocks = raw.split(/\n\n+/);
        let html = '';
        blocks.forEach(block => {
          // Numbered list
          if (/^(\d+\.\s+.+\n?)+$/.test(block)) {
            html += '<ol>' + block.split(/\n/).map(line => {
              const match = line.match(/^\d+\.\s+(.+)/);
              return match ? `<li>${match[1]}</li>` : '';
            }).join('') + '</ol>';
          }
          // Bullet list
          else if (/^(\*\s+.+\n?)+$/.test(block)) {
            html += '<ul>' + block.split(/\n/).map(line => {
              const match = line.match(/^\*\s+(.+)/);
              return match ? `<li>${match[1]}</li>` : '';
            }).join('') + '</ul>';
          }
          // Paragraph
          else {
            html += `<p>${block.replace(/\n/g, '<br>')}</p>`;
          }
        });
        return html;
      }

      messageDiv.className = `message ${isUser ? 'user-message' : 'agent-message'}`;
      messageDiv.innerHTML = renderMessage(text);
      chatDiv.appendChild(messageDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function setLoading(loading) {
      sendBtn.disabled = loading;
      msgInput.disabled = loading;
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        send();
      }
    }

    async function send() {
      const msg = msgInput.value.trim();
      if (!msg) return;

      setLoading(true);
      appendMessage(msg, true);
      msgInput.value = '';

      try {
        // Close any existing SSE connection
        if (evtSource) {
          evtSource.close();
        }

        // Send the message
        await fetch('/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({message: msg})
        });

        // Open new SSE connection for response
        evtSource = new EventSource("/chat");
        evtSource.onmessage = function(event) {
          console.log('Received message:', event.data);
          
          if (event.data) {
            try {
              // Just handle the clean text response
              appendMessage(event.data);
            } catch (e) {
              console.error('Error displaying message:', e);
              appendMessage('Sorry, there was an error displaying the message.');
            }
          }
          setLoading(false);
          evtSource.close();
        };
        evtSource.onerror = function(err) {
          console.error('EventSource error:', err);
          setLoading(false);
          evtSource.close();
        };
      } catch (error) {
        console.error('Error:', error);
        appendMessage('Sorry, something went wrong. Please try again.');
        setLoading(false);
      }
    }

    // Get initial message from LLM
    async function getInitialMessage() {
      try {
        setLoading(true);
        evtSource = new EventSource("/chat");
        evtSource.onmessage = function(event) {
          if (event.data) {
            try {
              const message = event.data.startsWith('{') ? 
                JSON.parse(event.data).message : 
                event.data;
              appendMessage(message);
            } catch (e) {
              appendMessage(event.data);
            }
          }
          setLoading(false);
          evtSource.close();
        };
        evtSource.onerror = function(err) {
          console.error('EventSource error:', err);
          setLoading(false);
          evtSource.close();
        };
      } catch (error) {
        console.error('Error getting initial message:', error);
        setLoading(false);
      }
    }

    // Start the chat with LLM's initial message
    getInitialMessage();
  </script>
</body>
</html>
